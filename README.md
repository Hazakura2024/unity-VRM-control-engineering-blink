# VRMモデル&制御工学で自然なまばたき with Unity

VRMモデルの「まばたき」を、単なるアニメーション再生ではなく、
制御工学の物理シミュレーションとして、Unityプロジェクトで作成しました。
また、パラメータの数値を変更すると「眠そうな目」「驚いた目」にもできます。

![blinkcontrol](docs\blinkcontrol.gif)

<br>
また、vrmモデルが移動とジャンプでマップ内を動き回れる3dアクションゲーム機能も作成しています。
グラフィックも環境色・コントラストなどの調整で綺麗に見える工夫も行いました。

## 📝 概要

大学で学んだ制御工学がとても面白く、何か実用できないかと考えていたところ、自分が興味を抱いていた3Dキャラクターモデルの挙動に応用できるのではないかと考え、実験的に作成しました！！！<br>
まぶたの開閉運動を「インパルス入力＋質量・ばね・ダンパ系(2次遅れ)」として捉え、運動方程式をリアルタイムに解くことで以下のような挙動をします。<br>
また、まばたきのクールタイムもポアソン分布で自然な間隔を計算しています。
* オーバーシュート: 勢いよく閉じた際に、皮膚の弾性で少しプルンと震えることの再現。
* 粘弾性: 過減衰で眠い時の重いまぶたが、不足減衰でパッチリした目表現ができる。
* ランダム性: 不規則なまばたき間隔をポアソン分布に基づいて作成。

<!-- ## ✨ 特徴 -->

## 📦 環境

* Unity 6 
* UniVRM (VRM 1.0)


## 🚀 リポジトリについて

以下のアセット等を再配布にならないようgithubに登録していません。
1.  /Assets/Proxy Games/Stylized Nature Kit Lite
2.  /Assets/Models/RadDollV3_VRM.vrm
3.  /Assets/AllSkyFree/Epic_BlueSunset
4.  /Assets/StarterAssets/ThirdPersonController


## ⚙️ パラメータ設定

Inspectorから以下の数値を調整すると、まばたきの種類を変えられます。
![parameter](docs\parameter.png )

| パラメータ | 変数名 | 推奨値 | 説明 |
| :--- | :--- | :--- | :--- |
| 固有角周波数 | `Omega_n` | `30` ~ `40` | まばたきの速さ（バネの強さ）。値が大きいほど速くに動く。 |
| 減衰係数 | `Zeta` | `0.5` ~ `1.0` | 1.0 (臨界減衰): シュパッと動くナチュラルなまばたき。<br>< 1.0 (不足減衰): 閉じた瞬間にプルンと震える（オーバーシュート）。驚きの表現になるかも。<br>> 1.0 (過減衰): ヌルっとゆっくり動く、眠そうな目。 |

## 📐 理論

### 1. 運動方程式（2次遅れ系）
まぶたの現在位置 $x(t)$ と目標位置 $r(t)$ の関係を以下の微分方程式でモデル化しています。

$$
\ddot{x} = \omega_n^2 (r - x) - 2\zeta\omega_n \dot{x}
$$

* $x$: まぶたの開閉度 (0.0 ~ 1.0)
* $r$: 目標値 (開=0, 閉=1)
* $\omega_n$: 固有角周波数
* $\zeta$: 減衰係数d

時間($\Delta t$)との乗算で数値積分(オイラー法)し、毎フレームのまぶたの開き具合(Weight)を決定しています。

### 2. 発生間隔（ポアソン分布）
まばたきの発生間隔 $T$ は、平均時間を $\mu$ とする指数分布に従います。

$$
P(t) = \lambda e^{-\lambda t} \quad (\lambda = 1/\mu)
$$

プログラム上では乱数 $U$ を用いて対数により生成しています。
$$
t = -\mu \ln(U)
$$
まばたきの間隔を基本は3.5秒おき、たまに短い間隔で連続する、といった自然な挙動になります。


## 👤 Author

[NISHIO Yutaro / Hazakura2024]